name: SE333_CI

on:
  push:
    branches:
      - main

jobs:
  SE333_CI_JOB:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java (JDK 23)
        uses: actions/setup-java@v4
        with:
          java-version: '23'
          distribution: 'temurin'
          architecture: x64

      # --- Static analysis first (Maven Checkstyle Plugin), do not fail build ---
      - name: Run Checkstyle (validate phase)
        run: |
          mvn -B -Dcheckstyle.failOnViolation=false validate checkstyle:checkstyle
          mkdir -p artifacts
          if [ -f target/checkstyle-result.xml ]; then
            cp target/checkstyle-result.xml artifacts/checkstyle.xml
          elif [ -f target/checkstyle.xml ]; then
            cp target/checkstyle.xml artifacts/checkstyle.xml
          else
            echo "No Checkstyle report found."
          fi

      - name: Upload Checkstyle Report
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle.xml
          path: artifacts/checkstyle.xml
          if-no-files-found: warn

      # --- use JaCoCo 0.8.12 agent + CLI directly ---
      - name: Download JaCoCo 0.8.12 (agent + cli)
        run: |
          mkdir -p $RUNNER_TEMP/jacoco
          curl -sL -o $RUNNER_TEMP/jacoco/jacocoagent.jar https://repo1.maven.org/maven2/org/jacoco/org.jacoco.agent/0.8.12/org.jacoco.agent-0.8.12-runtime.jar
          curl -sL -o $RUNNER_TEMP/jacoco/jacococli.jar   https://repo1.maven.org/maven2/org/jacoco/org.jacoco.cli/0.8.12/org.jacoco.cli-0.8.12-nodeps.jar

      - name: Run tests with JaCoCo agent (inject via surefire argLine)
        run: |
          # Write coverage to workspace root as jacoco.exec
          mvn -B -DargLine="-javaagent:$RUNNER_TEMP/jacoco/jacocoagent.jar=destfile=${{ github.workspace }}/jacoco.exec,append=false" test

      - name: Generate JaCoCo XML report via CLI
        run: |
          mkdir -p artifacts
          if [ -f "${{ github.workspace }}/jacoco.exec" ]; then
            java -jar $RUNNER_TEMP/jacoco/jacococli.jar report "${{ github.workspace }}/jacoco.exec" \
              --classfiles target/classes \
              --sourcefiles src/main/java \
              --xml artifacts/jacoco.xml
          else
            echo "No jacoco.exec found; tests may not have run."
          fi

      - name: Upload JaCoCo Report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco.xml
          path: ''


